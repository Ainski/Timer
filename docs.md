# 计时器（timer）模块设计文档


## 1. 模块概述
本模块是一个可配置的计时器，支持正计时和倒计时功能，具备参数写入、启动/停止、复位/中断等控制接口，并能在计时结束时输出报警信号。模块通过时钟信号驱动，可配置时、分、秒参数，适用于各类需要时间计量的场景。


## 2. 接口说明
| 信号名       | 方向 | 位宽          | 功能描述                                                                 |
|--------------|------|---------------|--------------------------------------------------------------------------|
| `clk`        | 输入 | 1 bit         | 时钟信号，上升沿触发计时逻辑                                             |
| `write`      | 输入 | 1 bit         | 写入使能（高电平有效），有效时可写入初始时间参数和计数方向                 |
| `up`         | 输入 | 1 bit         | 计数方向控制：1=正计时，0=倒计时（需配合`write`信号写入生效）             |
| `cut_n`      | 输入 | 1 bit         | 复位/中断信号（低电平有效）：有效时中止计时，重置状态并允许重新写入参数   |
| `insec`      | 输入 | `width-1:0`   | 初始秒数输入（`width`为宏定义，默认16位）                                |
| `inmin`      | 输入 | `width-1:0`   | 初始分钟输入（同上）                                                    |
| `inhour`     | 输入 | `width-1:0`   | 初始小时输入（同上）                                                    |
| `start`      | 输入 | 1 bit         | 启动信号（高电平有效）：有效时开始计时（正计时/倒计时）                   |
| `sec`        | 输出 | `width-1:0`   | 当前秒数输出                                                             |
| `min`        | 输出 | `width-1:0`   | 当前分钟输出                                                             |
| `hour`       | 输出 | `width-1:0`   | 当前小时输出                                                             |
| `alarm`      | 输出 | 1 bit         | 报警信号（高电平有效）：计时结束时触发（正计时到目标值/倒计时到0）         |
| `buzy_n`     | 输出 | 1 bit         | 忙状态信号（低电平有效）：低电平时表示正在计时，禁止写入参数；高电平时允许写入 |


## 3. 功能描述
### 3.1 核心功能
- **正计时**：从0开始计数，直至达到`write`信号写入的目标时间（`insec`/`inmin`/`inhour`），触发`alarm`。
- **倒计时**：从`write`信号写入的初始时间开始递减，直至0，触发`alarm`。


### 3.2 控制逻辑
1. **参数写入**：  
   当`write=1`且`buzy_n=1`（非忙状态）时，将`insec`/`inmin`/`inhour`写入内部寄存器作为目标时间（正计时）或初始时间（倒计时），同时写入`up`的计数方向。写入后`buzy_n`变为0（进入忙状态）。

2. **启动计时**：  
   当`start=1`且非复位/中断状态（`cut_n=1`）时，开始计时（正计时/倒计时由`up`决定）。

3. **复位/中断**：  
   当`cut_n=0`（低电平）时，立即中止计时，`buzy_n`变为1（退出忙状态），重置内部计时寄存器，允许重新写入参数。

4. **计时结束**：  
   - 正计时：当前时间（`sec_r`/`min_r`/`hour_r`）等于目标时间时，`alarm=1`，计时停止，`buzy_n=1`。  
   - 倒计时：当前时间减至0时，`alarm=1`，计时停止，`buzy_n=1`。

5. **忙状态控制**：  
   - 计时过程中`buzy_n=0`，禁止写入参数。  
   - 计时结束（`alarm=1`）或复位（`cut_n=0`）后，`buzy_n=1`，允许写入新参数。


## 4. 内部寄存器说明
| 寄存器名         | 位宽          | 功能描述                                                                 |
|------------------|---------------|--------------------------------------------------------------------------|
| `sec_set`/`min_set`/`hour_set` | `width-1:0` | 存储写入的目标时间（正计时）或初始时间（倒计时）                           |
| `up_r`           | 1 bit         | 存储计数方向（1=正计时，0=倒计时），由`up`配合`write`写入                 |
| `sec_r`/`min_r`/`hour_r` | `width-1:0` | 实时计时寄存器，存储当前秒/分/小时值                                     |
| `buzy_n_r`       | 1 bit         | `buzy_n`信号的寄存器版本，标识当前是否为忙状态                           |
| `buzy_n_r_last`  | 1 bit         | 存储`buzy_n_r`的上一状态（辅助状态判断）                                 |


## 5. 时序逻辑说明
所有逻辑均在`clk`上升沿触发，主要时序逻辑分为三部分：

1. **参数写入逻辑**：  
   检测`cut_n`和`write`信号，在非复位且允许写入时，更新`sec_set`/`min_set`/`hour_set`和`up_r`，并设置`buzy_n_r=0`（进入忙状态）。

2. **忙状态控制逻辑**：  
   复位（`cut_n=0`）或计时结束（`alarm=1`）时，`buzy_n_r=1`（退出忙状态）；启动计时（`start=1`）时，`buzy_n_r=0`（进入忙状态）。

3. **计时逻辑**：  
   - 复位、忙状态或计时结束时，重置计时寄存器（正计时重置为0，倒计时重置为初始值）。  
   - 正计时：每秒递增秒数，秒满60进1分钟，分钟满60进1小时。  
   - 倒计时：每秒递减秒数，秒为0时分钟减1并秒置59，分钟为0时小时减1并分钟/秒置59。


## 6. 宏定义说明
- `width`：默认值16，定义时间参数（时/分/秒）的位宽，可根据需求修改（如8位、32位）。